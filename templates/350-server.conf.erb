# File is managed by puppet

<% if scope.lookupvar('rsyslog::server::enable_udp') -%>
# Load UDP module
$ModLoad imudp
<% end -%>

<% if scope.lookupvar('rsyslog::server::enable_tcp') -%>
# Load TCP module
$ModLoad imtcp
<% end -%>

<% if scope.lookupvar('rsyslog::server::high_precision_timestamps') == false -%>
#
# Use traditional timestamp format.
# To enable high precision timestamps, comment out the following line.
#
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat
<% end -%>

<% if scope.lookupvar('rsyslog::server::enable_onefile') == false -%>
# Templates
$Template dynAuthLog,"<%= scope.lookupvar('rsyslog::server::server_dir') -%><%= scope.lookupvar('rsyslog::server::per_host_dir') -%>/auth.log"
$Template dynSyslog,"<%= scope.lookupvar('rsyslog::server::server_dir') -%><%= scope.lookupvar('rsyslog::server::per_host_dir') -%>/syslog"
$Template dynCronLog,"<%= scope.lookupvar('rsyslog::server::server_dir') -%><%= scope.lookupvar('rsyslog::server::per_host_dir') -%>/cron.log"
$Template dynDaemonLog,"<%= scope.lookupvar('rsyslog::server::server_dir') -%><%= scope.lookupvar('rsyslog::server::per_host_dir') -%>/daemon.log"
$Template dynKernLog,"<%= scope.lookupvar('rsyslog::server::server_dir') -%><%= scope.lookupvar('rsyslog::server::per_host_dir') -%>/kern.log"
$Template dynUserLog,"<%= scope.lookupvar('rsyslog::server::server_dir') -%><%= scope.lookupvar('rsyslog::server::per_host_dir') -%>/user.log"
$Template dynMailLog,"<%= scope.lookupvar('rsyslog::server::server_dir') -%><%= scope.lookupvar('rsyslog::server::per_host_dir') -%>/mail.log"
$Template dynDebug,"<%= scope.lookupvar('rsyslog::server::server_dir') -%><%= scope.lookupvar('rsyslog::server::per_host_dir') -%>/debug"
$Template dynMessages,"<%= scope.lookupvar('rsyslog::server::server_dir') -%><%= scope.lookupvar('rsyslog::server::per_host_dir') -%>/messages"

# Rules
auth,authpriv.*         ?dynAuthLog
*.*;auth,authpriv.none,mail.none,cron.none      -?dynSyslog
cron.*              ?dynCronLog
daemon.*            -?dynDaemonLog
kern.*              -?dynKernLog
mail.*              -?dynMailLog
user.*              -?dynUserLog
*.=info;*.=notice;*.=warn;\
    auth.none,authpriv.none;\
    cron.none,daemon.none;\
    mail.none,news.none     -?dynMessages
<% else -%>
# Template
$Template dynAllMessages,"<%= scope.lookupvar('rsyslog::server::server_dir') -%><%= scope.lookupvar('rsyslog::server::per_host_dir') -%>/messages"

# Rules
*.*                 -?dynAllMessages
<% end -%>
#
# Stop processing of all non-local messages. You can process remote messages
# on levels less than 35.
#
:fromhost-ip,!isequal,"127.0.0.1" ~

<% if scope.lookupvar('rsyslog::server::enable_udp') -%>
$UDPServerRun 514
<% end -%>

<% if scope.lookupvar('rsyslog::server::enable_tcp') -%>
$InputTCPServerRun 514
<% end -%>
